-- { echo }

DROP TABLE IF EXISTS test;
CREATE TABLE test
(
    dt DateTime
)
ENGINE = MergeTree
PARTITION BY toDate(dt)
ORDER BY tuple()
SETTINGS index_granularity = 1;
INSERT INTO test
SELECT toDateTime('2026-01-01 00:00:00') + number * 3600
FROM numbers(24 * 40);
SELECT count()
FROM test
WHERE has([toDateTime('2026-01-10 00:00:00')], dt);
1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE has([toDateTime('2026-01-10 00:00:00')], dt);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          MinMax
            Keys:
              dt
            Condition: (dt in 1-element set)
            Parts: 1/40
            Granules: 24/960
          Partition
            Keys:
              toDate(dt)
            Condition: (toDate(dt) in 1-element set)
            Parts: 1/1
            Granules: 24/24
          Ranges: 1
SELECT count()
FROM test
WHERE NOT has([toDateTime('2026-01-10 00:00:00')], dt);
959
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE NOT has([toDateTime('2026-01-10 00:00:00')], dt);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          MinMax
            Keys:
              dt
            Condition: not((dt in 1-element set))
            Parts: 40/40
            Granules: 960/960
          Partition
            Keys:
              toDate(dt)
            Condition: not((toDate(dt) in 1-element set))
            Parts: 40/40
            Granules: 960/960
          Ranges: 40
