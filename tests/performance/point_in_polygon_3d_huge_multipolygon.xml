<test>
    <drop_query>
        DROP TABLE IF EXISTS polys;
    </drop_query>

    <create_query>
        CREATE TABLE polys
        (
            poly Array(Array(Tuple(Int32,Int32)))
        ) ENGINE = Memory;
    </create_query>
    <create_query>
        INSERT INTO polys
        SELECT
            CAST(
                [
                    /* outer ring (closed) */
                    [
                        tuple(cx - r, cy - r),
                        tuple(cx + r, cy - r),
                        tuple(cx + r, cy + r),
                        tuple(cx - r, cy + r),
                        tuple(cx - r, cy - r)
                    ],
                    /* hole 1 (closed, CW) */
                    [
                        tuple(cx - dx - h1, cy - h1),
                        tuple(cx - dx - h1, cy + h1),
                        tuple(cx - dx + h1, cy + h1),
                        tuple(cx - dx + h1, cy - h1),
                        tuple(cx - dx - h1, cy - h1)
                    ],
                    /* hole 2 (closed, CW) */
                    [
                        tuple(cx + dx - h2, cy - h2),
                        tuple(cx + dx - h2, cy + h2),
                        tuple(cx + dx + h2, cy + h2),
                        tuple(cx + dx + h2, cy - h2),
                        tuple(cx + dx - h2, cy - h2)
                    ]
                ] AS Array(Array(Tuple(Int32, Int32)))
            ) AS poly
        FROM
        (
            SELECT
                number % 40 AS col,
                intDiv(number, 40) AS row,
                toInt32(toInt32(col) * 50 - 975) AS cx,
                toInt32(toInt32(row) * 50 - 600) AS cy,
                toInt32(20 + intHash64(number) % 5) AS r,
                toInt32(intDiv(r, 3)) AS dx,
                toInt32(intDiv(r, 3)) AS h1,
                toInt32(intDiv(r, 4)) AS h2
            FROM numbers(1000)
        );
    </create_query>
    <drop_query>
        DROP TABLE IF EXISTS multipoly_holder;
    </drop_query>
    <create_query>
        CREATE TABLE multipoly_holder
        (
            poly Array(Array(Array(Tuple(Int32,Int32))))
        ) ENGINE = Memory;
    </create_query>
    
    <create_query>
        INSERT INTO multipoly_holder
        SELECT groupArray(poly) AS poly
        FROM   polys;
    </create_query>
    
    <drop_query>
        DROP TABLE IF EXISTS points;
    </drop_query>
    
    <create_query>
        CREATE TABLE points
        (
            id UInt32,
            pt Tuple(Int32,Int32)
        ) ENGINE = MergeTree ORDER BY id;
    </create_query>
  
    <create_query>
        INSERT INTO points
        SELECT
            number AS id,
            tuple(
                toInt32(toInt64(intHash64(number * 41) % 2001) - 1000),
                toInt32(toInt64(intHash64(number * 43) % 2001) - 1000)
            ) AS pt
        FROM numbers(500_000);
    </create_query>

    <query>
        WITH
            (SELECT poly FROM multipoly_holder LIMIT 1) AS mp
        SELECT count()
        FROM points
        WHERE NOT ignore(pointInPolygon(pt, mp));
    </query>
    <drop_query>DROP TABLE IF EXISTS polys;</drop_query>
    <drop_query>DROP TABLE IF EXISTS multipoly_holder;</drop_query>
    <drop_query>DROP TABLE IF EXISTS points;</drop_query>
</test>
